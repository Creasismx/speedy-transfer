{% load static %}
<!-- Checkout -->
<style>
  .form-control {
    display: block;
    width: 100%;
    padding: 0.625rem 0.875rem;
    font-size: 0.95rem;
    line-height: 1.5;
    color: #1e293b;
    background-color: #fff;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .form-control:focus {
    border-color: #2dd4bf;
    outline: 0;
    box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.2);
  }

  .form-label {
    margin-bottom: 0.375rem;
    font-weight: 700;
    color: #64748b;
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .form-group {
    margin-bottom: 1rem;
  }
</style>

<section id="checkout-page" class="bg-slate-50 py-16">
  <div class="container mx-auto px-4">

    <!-- Trust Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-3">
        <svg class="w-8 h-8 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
          </path>
        </svg>
        Secure Checkout
      </h1>

    </div>

    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Billing Details -->
      <div class="lg:col-span-2 space-y-6">

        <div class="card bg-white shadow-md border 0 rounded-xl p-6 md:p-8">
          <h2 class="text-xl font-bold mb-6 text-gray-800 border-b pb-2">Billing Information</h2>
          <form id="billing-form" class="space-y-4">
            <!-- Order ID (Read-only, auto-incrementing) -->
            <div class="form-group hidden">
              <label for="order-id" class="form-label">Order #</label>
              <input type="text" id="order-id" class="form-control bg-slate-100 cursor-not-allowed" readonly
                value="Pending">
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div class="form-group">
                <label for="billing-first-name" class="form-label">First Name *</label>
                <input type="text" id="billing-first-name" class="form-control" required placeholder="John">
              </div>
              <div class="form-group">
                <label for="billing-last-name" class="form-label">Last Name *</label>
                <input type="text" id="billing-last-name" class="form-control" required placeholder="Doe">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div class="form-group">
                <label for="billing-email" class="form-label">Email Address *</label>
                <input type="email" id="billing-email" class="form-control" required placeholder="john@example.com">
              </div>
              <div class="form-group">
                <label for="billing-phone" class="form-label">Phone Number *</label>
                <input type="tel" id="billing-phone" class="form-control" required placeholder="+1 (555) 123-4567">
              </div>
            </div>

            <div class="form-group">
              <label for="billing-flight" class="form-label">Flight Number (Recommended)</label>
              <input type="text" id="billing-flight" class="form-control" placeholder="e.g., AA1234">
              <span class="text-xs text-muted">We track your flight to ensure we're there when you land.</span>
            </div>

            <hr class="border-slate-100 my-6">

            <div class="form-group">
              <label for="billing-address" class="form-label">Billing Address</label>
              <input type="text" id="billing-address" class="form-control" placeholder="123 Main St">
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div class="form-group">
                <label for="billing-city" class="form-label">City</label>
                <input type="text" id="billing-city" class="form-control">
              </div>
              <div class="form-group">
                <label for="billing-country" class="form-label">Country</label>
                <input type="text" id="billing-country" class="form-control" value="Mexico">
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div class="form-group">
                <label for="billing-state" class="form-label">State/Province</label>
                <input type="text" id="billing-state" class="form-control">
              </div>
              <div class="form-group">
                <label for="billing-zip" class="form-label">Postal Code</label>
                <input type="text" id="billing-zip" class="form-control">
              </div>
            </div>

            <hr class="border-slate-100 my-6">

            <div class="form-group">
              <h3 class="text-lg font-bold mb-4 text-gray-800">Additional Information</h3>
              <label for="special-instructions" class="form-label">Special Requests</label>
              <textarea id="special-instructions" rows="2" class="form-control"
                placeholder="Child seats, accessibility needs, etc..."></textarea>
            </div>

            <!-- Hidden/Optional fields preserved for compatibility but less prominent -->
            <div class="hidden">
              <input type="text" id="billing-company">
              <input type="date" id="billing-date-of-birth">
              <input type="text" id="billing-passport">
              <input type="text" id="emergency-contact-name">
              <input type="tel" id="emergency-contact-phone">
              <textarea id="additional-notes"></textarea>
            </div>
          </form>
        </div>

        <div class="card bg-white shadow-md border 0 rounded-xl p-6 md:p-8">
          <h3 class="text-xl font-bold mb-4 text-gray-800">Trip Summary</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-8 text-sm">
            <div>
              <p class="text-muted text-xs uppercase mb-1">Pickup</p>
              <p class="font-medium text-gray-900" id="c-origin">—</p>
              <p class="text-gray-500 text-xs mt-1" id="c-date">—</p>
              <p class="text-gray-500 text-xs" id="c-time">—</p>
            </div>
            <div>
              <p class="text-muted text-xs uppercase mb-1">Dropoff</p>
              <p class="font-medium text-gray-900" id="c-destination">—</p>
            </div>
            <div>
              <p class="text-muted text-xs uppercase mb-1">Vehicle</p>
              <p class="font-medium text-gray-900" id="c-vehicle">—</p>
              <p class="text-gray-500 text-xs mt-1">Pax: <span id="c-passenger">0</span></p>
            </div>
            <div>
              <p class="text-muted text-xs uppercase mb-1">Service</p>
              <p class="font-medium text-gray-900"><span id="c-service">OW</span> • <span id="c-flight">No Flight
                  Info</span></p>
            </div>
            <div class="md:col-span-2 border-t pt-2 mt-2" id="return-info-container">
              <div class="flex gap-8">
                <div>
                  <p class="text-muted text-xs uppercase mb-1">Return Date</p>
                  <p class="font-medium text-gray-900" id="c-return-date">—</p>
                </div>
                <div>
                  <p class="text-muted text-xs uppercase mb-1">Return Time</p>
                  <p class="font-medium text-gray-900" id="c-return-time">—</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary / Payments -->
      <div class="lg:col-span-1">
        <div class="sticky top-24">
          <div class="card bg-slate-800 text-white shadow-xl rounded-xl p-6">
            <h2 class="text-xl font-bold mb-6 flex justify-between items-center">
              Order Total
              <span class="text-secondary text-base font-normal badge badge-outline">USD</span>
            </h2>

            <div id="c-vehicles" class="space-y-4 mb-6 text-sm opacity-90"></div>

            <div class="border-t border-slate-600 my-4 pt-4 space-y-2">
              <div class="flex justify-between text-sm text-slate-300">
                <p>Capacity Check</p>
                <p id="c-capacity">0/0</p>
              </div>
              <div class="flex justify-between text-sm text-slate-300">
                <p>Subtotal</p>
                <p id="c-subtotal">$0.00</p>
              </div>
              <div class="flex justify-between text-xl font-bold text-white pt-2">
                <p>Total Due</p>
                <p id="c-total">$0.00</p>
              </div>
            </div>

            <div class="bg-slate-700/50 rounded p-3 mb-6 text-xs text-slate-300">
              <p class="mb-1"><span class="font-bold">Payment Method:</span> <span id="c-payment-method">Not
                  Selected</span></p>
              <p>Secure SSL Encrypted Transaction</p>
            </div>

            <div class="space-y-3">
              <form id="paypal-form" action="{% url 'core:create_payment' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="order_json" id="paypal-order-json" />
                <button type="submit"
                  class="btn w-full bg-[#ffc439] hover:bg-[#f4b62e] text-blue-900 border-0 font-bold shadow-md transition-all flex items-center justify-center gap-2">
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M7.076 21.337l.794-5.06h3.415c4.27 0 6.774-2.085 7.42-5.467.247-1.284.14-2.43-.326-3.41l.053-.027-.053.028a4.93 4.93 0 00-1.782-1.928c-1.314-.85-3.085-1.127-5.26-1.127H5l-3.33 21.337h5.406z" />
                  </svg>
                  Pay with PayPal
                </button>
              </form>

              <form id="stripe-form" action="{% url 'core:create_checkout_session' %}" method="get">
                {% csrf_token %}
                <input type="hidden" name="order_json" id="stripe-order-json" />
                <button type="submit"
                  class="btn w-full bg-[#6772e5] hover:bg-[#5469d4] text-white border-0 font-bold shadow-md transition-all flex items-center justify-center gap-2">
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                      d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.895-1.483 2.509-1.483 2.184 0 3.314 1.056 4.09 2.016l2.365-2.616c-1.298-1.572-3.435-2.731-6.455-2.731-4.764 0-7.892 2.37-7.892 6.035 0 2.583 1.956 4.316 5.613 5.483 3.013 0.983 3.65 1.564 3.65 2.559 0 0.925-0.966 1.636-2.622 1.636-2.31 0-3.668-1.055-4.498-2.261l-2.43 2.342c1.439 2.067 4.135 3.328 7.086 3.328 4.755 0 7.82-2.366 7.82-6.19 0-3.019-2.383-4.9-5.918-6.13M24 12c0 6.627-5.373 12-12 12S0 18.627 0 12 5.373 0 12 0s12 5.373 12 12">
                    </path>
                  </svg>
                  Pay with Card
                </button>
              </form>

              <!-- Cash Payment Option -->
              <button id="cash-button" type="button"
                class="btn w-full bg-[#22c55e] hover:bg-[#16a34a] text-white border-0 font-bold shadow-md transition-all flex items-center justify-center gap-2 mt-3">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
                  </path>
                </svg>
                Pay with Cash
              </button>
            </div>
          </div>

          <div class="mt-6 text-center">
            <p class="text-xs text-gray-500">Need help? Call us at <a href="#" class="text-primary hover:underline">+52
                (322) 123-4567</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (function () {
    function fmtMoney(amount, currency) {
      const num = isNaN(amount) ? 0 : Number(amount);
      return new Intl.NumberFormat(undefined, { style: 'currency', currency: currency || 'USD', minimumFractionDigits: 2 }).format(num);
    }
    function el(id) { return document.getElementById(id); }
    function val(id) { const n = el(id); return n ? (n.value || '').trim() : ''; }

    // Load data
    let selectedTransfers = [];
    let fechasData = null;
    try { selectedTransfers = JSON.parse(sessionStorage.getItem('selectedTransfers') || '[]'); } catch (e) { }
    try { fechasData = JSON.parse(sessionStorage.getItem('fechasData') || 'null'); } catch (e) { }

    // Generate temporary order ID
    function generateOrderId() {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000);
      return `ORD-${timestamp}-${random}`;
    }
    const tempOrderId = generateOrderId();
    if (el('order-id')) {
      el('order-id').value = tempOrderId;
    }

    // Populate trip details
    if (fechasData) {
      const pickup = fechasData.pickup_datetime ? fechasData.pickup_datetime.replace('T', ' ') : '';
      const ret = fechasData.return_datetime ? fechasData.return_datetime.replace('T', ' ') : '';

      // Parse date and time from pickup datetime
      let pickupDate = '';
      let pickupTime = '';
      if (pickup) {
        const dt = new Date(fechasData.pickup_datetime);
        pickupDate = dt.toLocaleDateString();
        pickupTime = dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Parse return date and time
      let returnDate = '';
      let returnTime = '';
      if (ret) {
        const dt = new Date(fechasData.return_datetime);
        returnDate = dt.toLocaleDateString();
        returnTime = dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      // Service type: OW = One Way, RT = Round Trip
      const serviceType = (fechasData.trip_type === 'roundtrip') ? 'RT' : 'OW';

      // Populate new fields
      if (el('c-origin')) el('c-origin').textContent = fechasData.pickup_location_name || '—';
      if (el('c-destination')) el('c-destination').textContent = fechasData.dropoff_location_name || '—';
      if (el('c-passenger')) el('c-passenger').textContent = fechasData.people || '0';
      if (el('c-vehicle')) el('c-vehicle').textContent = fechasData.car_type_label || fechasData.car_type_value || '—';
      if (el('c-date')) el('c-date').textContent = pickupDate || '—';
      if (el('c-time')) el('c-time').textContent = pickupTime || '—';
      if (el('c-service')) el('c-service').textContent = serviceType;
      if (el('c-return-date')) el('c-return-date').textContent = returnDate || '—';
      if (el('c-return-time')) el('c-return-time').textContent = returnTime || '—';

      // Flight number from form
      if (el('c-flight')) {
        const flightNum = val('billing-flight');
        el('c-flight').textContent = flightNum || 'Not provided';
      }
    }

    // Render vehicles
    const cVehicles = el('c-vehicles');
    const required = Number((fechasData && fechasData.people) || 0) || 0;
    let subtotal = 0;
    let capacity = 0;
    selectedTransfers.forEach(function (it) {
      const unit = Number(it.price_numeric || 0);
      subtotal += unit;
      capacity += Number(it.car_capacity || 0);
      const item = document.createElement('div');
      item.className = 'flex items-center justify-between border-b border-gray-line pb-2';
      item.innerHTML = `
      <div class="text-sm">
        <div class="font-semibold">${it.name || 'Vehicle'}</div>
        <div class="text-gray-600">${it.date || ''} ${it.time || ''}</div>
      </div>
      <div class="text-sm font-semibold">${fmtMoney(unit, it.currency || 'USD')}</div>
    `;
      cVehicles.appendChild(item);
    });
    el('c-capacity').textContent = `${capacity}/${required}`;
    el('c-subtotal').textContent = fmtMoney(subtotal, 'USD');
    el('c-total').textContent = fmtMoney(subtotal, 'USD');

    function buildOrder() {
      const order = {
        trip_type: (fechasData && fechasData.trip_type) || 'oneway',
        people: required,
        pickup: {
          datetime: (fechasData && fechasData.pickup_datetime) || '',
          location_id: (fechasData && fechasData.pickup_location_id) || '',
          location_name: (fechasData && fechasData.pickup_location_name) || ''
        },
        dropoff: {
          location_id: (fechasData && fechasData.dropoff_location_id) || '',
          location_name: (fechasData && fechasData.dropoff_location_name) || ''
        },
        return_trip: (fechasData && fechasData.trip_type) === 'roundtrip' ? {
          datetime: (fechasData && fechasData.return_datetime) || '',
          pickup_location_id: (fechasData && fechasData.return_pickup_location_id) || '',
          pickup_location_name: (fechasData && fechasData.return_pickup_location_name) || '',
          dropoff_location_id: (fechasData && fechasData.return_dropoff_location_id) || '',
          dropoff_location_name: (fechasData && fechasData.return_dropoff_location_name) || ''
        } : null,
        car_type_value: (fechasData && fechasData.car_type_value) || '',
        car_type_label: (fechasData && fechasData.car_type_label) || '',
        items: selectedTransfers.map(function (it) {
          return {
            rate_id: it.rate_id,
            car_id: it.car_id,
            name: it.name,
            unit_amount: Number(it.price_numeric || 0),
            currency: it.currency || 'USD',
            date: it.date,
            time: it.time,
            capacity: Number(it.car_capacity || 0),
            image_url: it.image_url
          };
        }),
        subtotal: subtotal,
        total: subtotal,
        order_id: tempOrderId,
        customer: {
          first_name: val('billing-first-name'),
          last_name: val('billing-last-name'),
          name: val('billing-first-name') + ' ' + val('billing-last-name'),
          email: val('billing-email'),
          phone: val('billing-phone'),
          address: val('billing-address'),
          city: val('billing-city'),
          state: val('billing-state'),
          zip: val('billing-zip'),
          country: val('billing-country') || 'Mexico',
          company: val('billing-company') || '',
          date_of_birth: val('billing-date-of-birth'),
          passport_number: val('billing-passport'),
          flight_number: val('billing-flight'),
          emergency_contact_name: val('emergency-contact-name'),
          emergency_contact_phone: val('emergency-contact-phone'),
          special_instructions: val('special-instructions'),
          additional_notes: val('additional-notes')
        },
        // Additional fields for display
        origin: (fechasData && fechasData.pickup_location_name) || '',
        destination: (fechasData && fechasData.dropoff_location_name) || '',
        passenger: required,
        vehicle: (fechasData && (fechasData.car_type_label || fechasData.car_type_value)) || '',
        date: (fechasData && fechasData.pickup_datetime) ? new Date(fechasData.pickup_datetime).toLocaleDateString() : '',
        time: (fechasData && fechasData.pickup_datetime) ? new Date(fechasData.pickup_datetime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
        service: ((fechasData && fechasData.trip_type) === 'roundtrip') ? 'RT' : 'OW',
        pay: subtotal,
        payment: 'Pending',
        currency: 'USD'
      };
      return order;
    }

    function refreshHiddenOrder() {
      try {
        const order = buildOrder();
        el('paypal-order-json').value = JSON.stringify(order);
        el('stripe-order-json').value = JSON.stringify(order);
        sessionStorage.setItem('order', JSON.stringify(order));
      } catch (e) { }
    }

    // Update flight number display when changed
    const flightInput = el('billing-flight');
    if (flightInput && el('c-flight')) {
      flightInput.addEventListener('input', function () {
        const flightNum = val('billing-flight');
        el('c-flight').textContent = flightNum || 'Not provided';
        refreshHiddenOrder();
      });
    }

    // Update payment method display
    const pf = el('paypal-form');
    const sf = el('stripe-form');
    if (pf) {
      pf.addEventListener('submit', function () {
        refreshHiddenOrder();
        if (el('c-payment-method')) el('c-payment-method').textContent = 'PayPal';
      });
    }
    if (sf) {
      sf.addEventListener('submit', function () {
        refreshHiddenOrder();
        if (el('c-payment-method')) el('c-payment-method').textContent = 'Stripe';
      });
    }

    // Initialize hidden inputs once
    refreshHiddenOrder();

    // ==========================================
    // BILLING FORM VALIDATION
    // ==========================================
    const billingForm = document.getElementById('billing-form');

    function validateBillingForm() {
      if (!billingForm) return true;
      if (!billingForm.reportValidity()) {
        return false;
      }
      refreshHiddenOrder(); // Update with latest values
      return true;
    }

    // Reuse existing reference or re-query if needed (but duplicated const is invalid)
    // const pf = el('paypal-form'); // Already declared above
    // const sf = el('stripe-form'); // Already declared above

    if (pf) {
      pf.addEventListener('submit', function (e) {
        if (!validateBillingForm()) {
          e.preventDefault();
          e.stopPropagation();
          alert('Please fill in all required billing details before paying.');
          return false;
        }
        if (el('c-payment-method')) el('c-payment-method').textContent = 'PayPal';
      });
    }

    if (sf) {
      sf.addEventListener('submit', function (e) {
        if (!validateBillingForm()) {
          e.preventDefault();
          e.stopPropagation();
          alert('Please fill in all required billing details before paying.');
          return false;
        }
        if (el('c-payment-method')) el('c-payment-method').textContent = 'Stripe';
      });
    }

    // Cash Payment Handler
    const cashBtn = el('cash-button');
    if (cashBtn) {
      cashBtn.addEventListener('click', function () {
        if (!validateBillingForm()) {
          alert('Please fill in all required billing details before paying.');
          return;
        }

        refreshHiddenOrder();

        if (el('c-payment-method')) el('c-payment-method').textContent = 'Cash on Arrival';

        // Disable button to prevent double submit
        const originalText = cashBtn.innerHTML;
        cashBtn.disabled = true;
        cashBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Processing...';

        const order = buildOrder();
        // Get CSRF token from inputs or cookie
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfInput ? csrfInput.value : '';

        fetch("{% url 'core:create_cash_payment' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ order_json: JSON.stringify(order) })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.redirect_url) {
              window.location.href = data.redirect_url;
            } else {
              alert('Error creating booking: ' + (data.error || 'Unknown error'));
              console.error('Server Error:', data);
              cashBtn.disabled = false;
              cashBtn.innerHTML = originalText;
            }
          })
          .catch(error => {
            console.error('Network Error:', error);
            alert('Network error. Please try again.');
            cashBtn.disabled = false;
            cashBtn.innerHTML = originalText;
          });
      });
    }

  })();
</script>