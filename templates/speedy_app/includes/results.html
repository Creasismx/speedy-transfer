{% load static %}
<style>
/* Enhanced visual highlight for selected transfer cards */
.transfer-card {
  position: relative;
  border-radius: 1rem; /* match rounded-box look */
  transition: transform 200ms ease, box-shadow 200ms ease, background-color 200ms ease, border-color 200ms ease;
}

.transfer-card.selected {
  background: linear-gradient(90deg, rgba(74, 187, 193, 0.12), rgba(4, 120, 132, 0.06));
  box-shadow: 0 10px 25px rgba(4, 120, 132, 0.25), 0 0 0 3px rgba(74, 187, 193, 0.65) inset;
  transform: translateY(-2px);
  border-color: #4abbc1;
}

.transfer-card.selected::after {
  content: 'Selected';
  position: absolute;
  top: 10px;
  right: 12px;
  background: #4abbc1;
  color: #ffffff;
  font-weight: 700;
  font-size: 12px;
  letter-spacing: 0.02em;
  padding: 6px 10px;
  border-radius: 9999px;
  box-shadow: 0 4px 12px rgba(4, 120, 132, 0.3);
}

.transfer-card .card-title,
.transfer-card .stat-value {
  transition: color 200ms ease;
}

.transfer-card.selected .card-title,
.transfer-card.selected .stat-value {
  color: #047884; /* accent text */
}

.transfer-card.selected img {
  outline: 3px solid rgba(74, 187, 193, 0.5);
  outline-offset: 2px;
  border-radius: 0.75rem;
}

@keyframes pulseRing {
  0% { box-shadow: 0 0 0 0 rgba(74, 187, 193, 0.5); }
  70% { box-shadow: 0 0 0 12px rgba(74, 187, 193, 0); }
  100% { box-shadow: 0 0 0 0 rgba(74, 187, 193, 0); }
}

.transfer-card.selected::before {
  content: '';
  position: absolute;
  inset: -2px;
  border-radius: inherit;
  pointer-events: none;
  animation: pulseRing 1.6s ease-out;
}
</style>
<section id="results" class="grid items-center gap-8 py-16">
  <article class="prose lg:prose-xl pl-4">
    <h1 class="text-2xl antialiased md:subpixel-antialiased font-bold">Select transfer for your ARRIVAL</h1>
  </article>
   
  <div class="overflow-x-auto">
    {% if transfer_options %}
      {% for option in transfer_options %}
      <div class="transfer-card card lg:card-side bg-base-100 shadow-sm card-border p-4 mb-2 transition-all duration-300 ease-in-out hover:shadow-xl cursor-pointer"
           data-transfer-id="{{ option.id }}"
           data-rate-id="{{ option.rate_id }}"
           data-car-id="{{ option.car_id }}"
           data-unit-number="{{ option.unit_number }}"
           data-vehicle-id="{{ option.id }}"
           data-car-capacity="{{ option.car_capacity }}"
           data-travel-type="{{ option.travel_type }}"
           data-price="{{ option.price }}"
           data-image-url="{{ option.image_url }}"
           data-departure-date="{{ option.departure_date }}"
           data-departure-time="{{ option.departure_time }}">
        <figure>
          {% if option.image_url %}
            <img
              src="{{ option.image_url }}"
              alt="{{ option.car_name }}"
              class="rounded-box w-80 h-60 object-cover rounded-lg shadow-lg"
              onerror="console.log('Image failed: {{ option.image_url }}'); this.src='https://placehold.co/192x128/4abbc1/ffffff?text={{ option.car_name|urlencode }}'; this.onerror=null;" />
          {% else %}
            <img
              src="https://placehold.co/192x128/4abbc1/ffffff?text={{ option.car_name|urlencode }}"
              alt="{{ option.car_name }}"
              class="rounded-box w-100 max-w-sm rounded-lg shadow-2xl" />
          {% endif %}
        </figure>
        <div class="card-body">
          <h2 class="card-title text-xl font-bold">{{ option.car_name }}</h2>
          <p>Max {{ option.car_capacity }} people per vehicle</p>
          {% if option.unit_number > 1 %}
          <p class="text-sm text-gray-600">Unit #{{ option.unit_number|stringformat:"03d" }} â€¢ {{ option.availability_status|title }}</p>
          {% endif %}
          <div class="stats stats-vertical lg:stats-horizontal shadow">
            <div class="stat">
              <div class="stat-title">Departure date</div>
              <div class="stat-value">{{ option.departure_date }}</div>
            </div>
                     
            <div class="stat">
              <div class="stat-title">Departure time</div>
              <div class="stat-value">{{ option.departure_time }}</div>
            </div>
                     
            <div class="stat">
              <div class="stat-title">Per vehicle</div>
              <div class="stat-value price-value text-success">${{ option.price }} USD</div>
            </div>
          </div>
          <div class="card-actions justify-end">
            <button class="select-btn btn btn-block bg-[#4abbc1] border-0 text-white hover:bg-[#3fa8b0]">
              Select {% if option.total_fleet_size > 1 %}Unit #{{ option.unit_number|stringformat:"03d" }}{% endif %}
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <!-- Debug section to show what data is available -->
      <div class="alert alert-warning">
        <div>
          <h3>No transfer options found</h3>
          <p><strong>Debug Info:</strong></p>
          <ul>
            <li>Pickup Location: {{ pickup_location }}</li>
            <li>Car Type: {{ car_type }}</li>
            <li>Trip Type: {{ trip_type }}</li>
            <li>People: {{ people }}</li>
          </ul>
          <p>Please check if:</p>
          <ul>
            <li>Cars exist in the database with the selected type</li>
            <li>Rates are configured for the selected zone and car type</li>
            <li>The pickup location is valid</li>
          </ul>
        </div>
      </div>
    {% endif %}
    
    <div class="flex justify-end mt-4">
      <a href="{% url 'core:summary_view' %}" class="book-btn btn btn-wide btn-outline btn-success sm:btn-block">
        Book Transfers
      </a>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const transferCards = document.querySelectorAll('.transfer-card');
  const bookButton = document.querySelector('.book-btn');
  let selectedTransfer = null;

  console.log('Book button found:', bookButton);
  console.log('Transfer cards found:', transferCards.length);

  // Initially disable the book button
  if (bookButton) {
    bookButton.classList.add('btn-disabled');
    bookButton.classList.remove('btn-success');
    bookButton.classList.add('btn-outline');
    bookButton.classList.remove('bg-[#4abbc1]');
    bookButton.classList.remove('border-0');
    bookButton.style.pointerEvents = 'none';
    bookButton.style.opacity = '0.5';
    bookButton.textContent = 'Select a Vehicle First';
    
    // Store original href safely
    const currentHref = bookButton.getAttribute('href') || "{% url 'core:summary_view' %}";
    bookButton.setAttribute('data-original-href', currentHref);
    bookButton.removeAttribute('href');
  }

  function getSelectedOptionText(selectEl) {
    if (!selectEl) return '';
    const opt = selectEl.options[selectEl.selectedIndex];
    return opt ? opt.textContent.trim() : '';
  }

  function collectFechasData() {
    const pickupDT = document.querySelector('input[name="pickup_datetime"]');
    const pickupLoc = document.querySelector('select[name="pickup_location"]');
    const dropoffLoc = document.querySelector('select[name="dropoff_location"]');
    const returnDT = document.querySelector('input[name="return_datetime"]');
    const returnPickupLoc = document.querySelector('select[name="return_pickup_location"]');
    const returnDropoffLoc = document.querySelector('select[name="return_dropoff_location"]');
    const people = document.querySelector('input[name="people"]');
    const carType = document.querySelector('select[name="car_type"]');
    const tripType = document.querySelector('input[name="trip_type"]:checked');

    const pickupValue = pickupDT?.value || '';
    const returnValue = returnDT?.value || '';

    const fechasData = {
      pickup_datetime: pickupValue,
      pickup_date: pickupValue ? (pickupValue.split('T')[0] || '') : '',
      pickup_time: pickupValue ? (pickupValue.split('T')[1] || '') : '',
      pickup_location_id: pickupLoc?.value || '',
      pickup_location_name: getSelectedOptionText(pickupLoc),
      dropoff_location_id: dropoffLoc?.value || '',
      dropoff_location_name: getSelectedOptionText(dropoffLoc),
      return_datetime: returnValue,
      return_date: returnValue ? (returnValue.split('T')[0] || '') : '',
      return_time: returnValue ? (returnValue.split('T')[1] || '') : '',
      return_pickup_location_id: returnPickupLoc?.value || '',
      return_pickup_location_name: getSelectedOptionText(returnPickupLoc),
      return_dropoff_location_id: returnDropoffLoc?.value || '',
      return_dropoff_location_name: getSelectedOptionText(returnDropoffLoc),
      people: people?.value || '',
      car_type_value: carType?.value || '',
      car_type_label: getSelectedOptionText(carType),
      trip_type: tripType?.value || 'oneway'
    };

    return fechasData;
  }

  transferCards.forEach((card, index) => {
    card.addEventListener('click', function () {
      console.log('Vehicle card clicked:', index);
      
      // Remove 'selected' class from all other cards
      transferCards.forEach(c => {
        c.classList.remove('selected');
        c.classList.remove('ring-2');
        c.classList.remove('ring-4');
        c.classList.remove('ring-offset-2');
        c.classList.remove('ring-[#4abbc1]');
        c.classList.remove('shadow-xl');
        c.classList.remove('shadow-2xl');
      });
      
      // Add 'selected' class to the clicked card
      this.classList.add('selected');
      this.classList.add('ring-4');
      this.classList.add('ring-offset-2');
      this.classList.add('ring-[#4abbc1]');
      this.classList.add('shadow-2xl');
      
      // Extract data from attributes
      const cardTitle = this.querySelector('.card-title')?.textContent || 'Unknown Vehicle';
      const priceElement = this.querySelector('.price-value');
      const priceText = priceElement ? priceElement.textContent : '$0 USD';

      const transferId = this.getAttribute('data-transfer-id') || `vehicle_${index}`;
      const rateId = this.getAttribute('data-rate-id') || transferId;
      const carId = this.getAttribute('data-car-id') || '';
      const unitNumber = this.getAttribute('data-unit-number') || '1';

      const imageUrl = this.getAttribute('data-image-url') || this.querySelector('img')?.src || '';
      const carCapacity = parseInt(this.getAttribute('data-car-capacity') || '0', 10);
      const travelType = this.getAttribute('data-travel-type') || '';
      const priceNumeric = parseFloat(this.getAttribute('data-price') || '0');
      const departureDate = this.getAttribute('data-departure-date') || '';
      const departureTime = this.getAttribute('data-departure-time') || '';
      
      // Store selected transfer data
      selectedTransfer = {
        id: transferId,
        rate_id: rateId,
        car_id: carId,
        unit_number: unitNumber,
        name: cardTitle,
        price_text: priceText,
        price_numeric: isNaN(priceNumeric) ? 0 : priceNumeric,
        currency: 'USD',
        date: departureDate,
        time: departureTime,
        image_url: imageUrl,
        car_capacity: isNaN(carCapacity) ? null : carCapacity,
        travel_type: travelType,
        quantity: 1,
        selection_type: 'individual_vehicle'
      };
      
      console.log('Individual vehicle selected:', selectedTransfer);
      
      // Enable the book button with specific messaging
      if (bookButton) {
        bookButton.classList.remove('btn-disabled');
        bookButton.classList.remove('btn-outline');
        bookButton.classList.add('btn-success');
        bookButton.classList.add('bg-[#4abbc1]');
        bookButton.classList.add('border-0');
        bookButton.style.pointerEvents = 'auto';
        bookButton.style.opacity = '1';
        bookButton.textContent = `Book ${cardTitle}`;
        
        // Restore the href
        const originalHref = bookButton.getAttribute('data-original-href');
        if (originalHref) {
          bookButton.setAttribute('href', originalHref);
        }
      }
    });
  });

  // Book button click handler
  if (bookButton) {
    bookButton.addEventListener('click', function(e) {
      console.log('Book button clicked, selectedTransfer:', selectedTransfer);
      
      if (!selectedTransfer || !this.getAttribute('href')) {
        e.preventDefault();
        e.stopPropagation();
        alert('Please select a specific vehicle before proceeding.');
        return false;
      }
      
      // Store selection and fechas data
      try {
        const fechasData = collectFechasData();
        sessionStorage.setItem('selectedTransfer', JSON.stringify(selectedTransfer));
        sessionStorage.setItem('fechasData', JSON.stringify(fechasData));
        console.log('Saved selection and fechasData to sessionStorage', { selectedTransfer, fechasData });

        // Additional booking data (kept for downstream use if needed)
        sessionStorage.setItem('bookingData', JSON.stringify({
          vehicleType: 'individual',
          rateId: selectedTransfer.rate_id,
          carId: selectedTransfer.car_id,
          unitNumber: selectedTransfer.unit_number,
          selectionTimestamp: new Date().toISOString(),
          sessionId: Math.random().toString(36).substr(2, 9)
        }));
      } catch (err) {
        console.warn('Could not save selection to sessionStorage:', err);
        // Fallback - still allow booking to proceed
      }
      
      return true;
    });
  }
});
</script>